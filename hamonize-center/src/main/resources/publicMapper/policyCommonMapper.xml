<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
 
<mapper namespace="com.mapper.IPolicyCommonMapper">

	
	<!-- <insert id="addAnsibleJobEvent" parameterType="java.util.HashMap">
			INSERT INTO tbl_ansible_event_job 
				(DOMAIN,
				JOB_ID,
				ORG_SEQ,
				DATA,
				RGSTR_DATE) 
				VALUES
				<foreach collection="data" item="item" separator=",">
				(
					(select distinct domain from tbl_org where inventory_id = #{inventory_id}::int),
					#{job_id}::int,
					#{org_seq}::int,
					#{item.result}::jsonb,
					now()
				) on conflict (JOB_ID) DO update set 
				DOMAIN = (select distinct domain from tbl_org where inventory_id = #{inventory_id}::int),
				JOB_ID = #{job_id}::int,
				ORG_SEQ = #{org_seq}::int,
				DATA = #{item.result}::jsonb,
				RGSTR_DATE = now()
				</foreach>
	</insert> -->

	<insert id="addAnsibleJobEventByHost" parameterType="java.util.HashMap">
			INSERT INTO tbl_ansible_event_job 
				(DOMAIN,
				JOB_ID,
				ORG_SEQ,
				KIND,
				DATA,
				RGSTR_DATE) 
				VALUES
				<foreach collection="data" item="item" separator=",">
				(
					(select distinct domain from tbl_org where inventory_id = #{inventory_id}::int),
					#{job_id}::int,
					#{org_seq}::int,
					#{before_url},
					#{item.result}::jsonb,
					now()
				)
				</foreach>
	</insert>

	<insert id="addAnsibleJobEventByGroup" parameterType="java.util.HashMap">
			INSERT INTO tbl_ansible_policy_result 
				(DOMAIN,
				JOB_ID,
				ORG_SEQ,
				DATA,
				RGSTR_DATE) 
				VALUES
				(
					#{domain},
					#{job_id},
					#{org_seq}::int,
					#{object}::jsonb,
					now()
				)
	</insert>

	<insert id="addAnsibleJobRelaunchEventByHost" parameterType="java.util.HashMap">
		WITH rows AS (
			INSERT INTO tbl_ansible_event_job_relaunch 
				(DOMAIN,
				JOB_ID,
				PARENTS_JOB_ID,
				PC_UUID,
				DATA,
				RGSTR_DATE) 
				VALUES
				<foreach collection="data" item="item" separator=",">
				(
					(select distinct domain from tbl_org where inventory_id = #{inventory_id}::int),
					#{job_id}::int,
					#{parents_job_id}::int,
					#{pc_uuid},
					#{item.result}::jsonb,
					now()
				)
				</foreach>
				RETURNING data,parents_job_id,pc_uuid
		) UPDATE tbl_ansible_event_job SET data = (SELECT data from rows),RGSTR_DATE = now() WHERE job_id = (SELECT parents_job_id from rows)::int
		and (SELECT pc_uuid from rows) = data -> 'summary_fields' -> 'host' ->> 'description'
	</insert>

	<select id="checkCountAnsibleJobId" parameterType="java.util.HashMap" resultType="Integer">
	SELECT count(*) FROM tbl_ansible_event_job WHERE JOB_ID = #{job_id}::int
	</select>

	<delete id="deleteAnsibleJobEvent" parameterType="java.util.HashMap">
	DELETE FROM tbl_ansible_event_job WHERE JOB_ID = #{job_id}::int
	</delete>

	<select id="checkCountAnsibleJobRelaunchId" parameterType="java.util.HashMap" resultType="Integer">
	SELECT count(*) FROM tbl_ansible_event_job_relaunch WHERE JOB_ID = #{job_id}::int
	</select>

	<delete id="deleteAnsibleJobRelaunchEvent" parameterType="java.util.HashMap">
	DELETE FROM tbl_ansible_event_job_relaunch WHERE JOB_ID = #{job_id}::int
	</delete>

	<select id="getAnsibleJobEventByGroup" parameterType="java.util.HashMap" resultType="java.util.HashMap">
	SELECT data ->> 'module_args' as module_args FROM tbl_ansible_policy_result where JOB_ID = #{job_id}::int
	</select>

</mapper>
